@if (Node != null)
{    
    <div class="node-item m-0 p-0" data-id="@(Node.Id)" id="@($"node-{Node.Id}")">
        <a @onclick="@OnNodeClick" class="node__label @(ActivePage?.Id == Node.Id ? "selected" : "")">
            @if (Node.Pages != null && Node.Pages.Count > 0)
            {
                if (IsExpanded(Node.Id ?? string.Empty))
                {
                    <MatIcon>@MatIconNames.Keyboard_arrow_down</MatIcon>
                    <MatIcon>@MatIconNames.Folder_open</MatIcon>
                }
                else
                {
                    <MatIcon>@MatIconNames.Keyboard_arrow_right</MatIcon>
                    <MatIcon>@MatIconNames.Folder</MatIcon>
                }
            }
            else
            {
                <MatIcon Style="opacity: 0">@MatIconNames.Keyboard_arrow_right</MatIcon>
                <MatIcon>@MatIconNames.Folder</MatIcon>
            }
            @Node.Name
        </a>

        @if (IsExpanded(Node.Id ?? string.Empty) && Node.Pages?.Count > 0)
        {
            <div class="node-children" id="@Node.Id">
                <Dropzone Items="Node.Pages" Accepts="@AcceptDrop">
                    <AdminContentItem Node="@context" ActivePage="@ActivePage" NodeClick="@NodeClick" ExpandedNodes="@ExpandedNodes"></AdminContentItem>
                </Dropzone>
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public Page? Node { get; set; }

    [Parameter]
    public Page? ActivePage { get; set; }

    [Parameter]
    public EventCallback<Page> NodeClick { get; set; }

    [Parameter]
    public List<string> ExpandedNodes { get; set; } = new();

    public bool IsExpanded(string id) => ExpandedNodes.Contains(id);

    public async Task OnNodeClick()
    {
        await NodeClick.InvokeAsync(Node);
    }

    public bool AcceptDrop(Page droppedItem, Page? target)
    {
        if (target == null) return true;
        return ContainsPage(droppedItem, target);
    }

    private bool ContainsPage(Page item, Page parent)
    {
        if (parent.Pages.Contains(item)) return true;
        foreach (var p in parent.Pages)
        {
            if (ContainsPage(item, p)) return true;
        }
        return false;
    }
}
